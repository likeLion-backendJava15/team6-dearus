<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>ë‚´ ì¼ê¸°ì¥</title>
    <link rel="stylesheet" th:href="@{/css/entry.css}" />
    <style>
      body {
        padding: 20px;
        font-family: sans-serif;
      }

      .diary-list {
        list-style: none;
        padding: 0;
      }

      .diary-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .diary-name {
        font-weight: bold;
        font-size: 18px;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
      }

      .button-container {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        padding: 7px 10px;
        font-size: 13px;
        cursor: pointer;
        border-radius: 10px;
        background-color: #88b5e9;
        color: rgb(255, 255, 255);
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
        border: none;
      }

      .btn:hover {
        background-color: #4271a7;
      }
    </style>
  </head>
  <body>
    <div th:replace="fragments/header :: header"></div>

    <h2>ğŸ“š ë‚´ ì¼ê¸°ì¥</h2>

    <div class="button-container">
      <a th:href="@{/diary/form}" class="btn">+ ìƒˆ ì¼ê¸°ì¥ ë§Œë“¤ê¸°</a>
      <a th:href="@{/tags}" class="btn">ğŸ”– ë‚´ íƒœê·¸ ë³´ê¸°</a>
      <button class="btn" onclick="openInvitePopup()">ğŸ“¬ ë°›ì€ ì´ˆëŒ€</button>
      <div
        id="invite-modal"
        style="
          display: none;
          position: fixed;
          top: 20%;
          left: 50%;
          transform: translate(-50%, 0);
          background: white;
          border: 1px solid #ccc;
          padding: 20px;
          z-index: 1000;
        "
      >
        <h3>ğŸ“¨ ë°›ì€ ì´ˆëŒ€ ëª©ë¡</h3>
        <div id="invite-list">
          <!-- ì—¬ê¸°ì— ì´ˆëŒ€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
        <button onclick="closeInvitePopup()" style="margin-top: 10px">
          ë‹«ê¸°
        </button>
      </div>
    </div>

    <hr style="background-color: #cccccc; height: 1px; border: 0" />

    <ul class="diary-list">
      <li th:each="diary : ${diaries}" class="diary-item">
        <!-- ì™¼ìª½: ì´ë¦„ -->
        <div class="diary-info">
          <a
            th:href="@{'/entry/list'(diaryId=${diary.id})}"
            class="diary-name"
            th:text="${diary.name}"
          ></a>
          <span th:if="${diary.isOwner}" class="crown">ğŸ‘‘</span>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì •/ì‚­ì œ -->
        <div style="display: flex; flex-direction: column; gap: 5px">
          <!-- ë²„íŠ¼ë“¤: ê°€ë¡œë¡œ ë‚˜ì—´ -->
          <div style="display: flex; gap: 10px" th:if="${diary.isOwner}">
            <button class="btn" th:onclick="|toggleInviteForm(${diary.id})|">
              ğŸ“¨ ë©¤ë²„ ì´ˆëŒ€
            </button>
            <a th:href="@{/diary/{id}/members(id=${diary.id})}" class="btn"
              >ğŸ‘¥ ë©¤ë²„ ê´€ë¦¬</a
            >
            <a th:href="@{/diary/form(editId=${diary.id})}" class="btn"
              >âœï¸ ìˆ˜ì •</a
            >
            <button
              type="button"
              class="btn"
              th:onclick="|deleteDiary(${diary.id})|"
            >
              ğŸ—‘ï¸ ì‚­ì œ
            </button>
          </div>

          <!-- ì´ˆëŒ€ ì…ë ¥ì°½: ë²„íŠ¼ ì•„ë˜ì— ì„¸ë¡œë¡œ í‘œì‹œ -->
          <div
            th:attr="id='invite-form-' + ${diary.id}"
            style="display: none; margin-top: 10px"
          >
            <input
              th:attr="id='invite-email-' + ${diary.id}"
              type="email"
              placeholder="ì´ˆëŒ€í•  ì´ë©”ì¼ ì…ë ¥"
              style="padding: 5px; width: 250px"
            />
            <button class="btn" th:onclick="|sendInvite(${diary.id})|">
              ì´ˆëŒ€
            </button>
          </div>
        </div>
      </li>
    </ul>

    <form th:action="@{/logout}" method="post" style="display: inline">
      <button type="submit" class="logout-btn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
    </form>

    <!--  --  --  --  -- script --  --  --  -- -->
    <script>
      // ë©¤ë²„ ì´ˆëŒ€
      const diaryId = /*[[${diaryId}]]*/ 0; // Thymeleafì—ì„œ diaryId ì£¼ì…

      function toggleInviteForm(diaryId) {
        const form = document.getElementById(`invite-form-${diaryId}`);
        form.style.display = form.style.display === "none" ? "block" : "none";
      }

      function sendInvite(diaryId) {
        const emailInput = document.getElementById(`invite-email-${diaryId}`);
        const email = emailInput.value.trim();

        if (!email) {
          alert("ì´ˆëŒ€ë¥¼ ë³´ë‚¼ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        fetch(`/api/diary/${diaryId}/invite`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email: email }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("ì´ˆëŒ€ ì‹¤íŒ¨");
            alert("ì´ˆëŒ€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            emailInput.value = "";
            toggleInviteForm(diaryId);
          })
          .catch((err) => {
            alert(err.message);
          });
      }

      // ì´ˆëŒ€ í™•ì¸
      function openInvitePopup() {
        fetch("/api/diary/invites")
          .then((res) => {
            if (!res.ok) throw new Error("ì´ˆëŒ€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            return res.json();
          })
          .then((invites) => {
            const listDiv = document.getElementById("invite-list");
            listDiv.innerHTML = "";

            if (invites.length === 0) {
              listDiv.innerHTML = "<p>ë°›ì€ ì´ˆëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            } else {
              invites.forEach((invite) => {
                const entry = document.createElement("div");
                entry.innerHTML = `
              <p><strong>${invite.diaryName}</strong>ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <button onclick="acceptInvite(${invite.diaryId})">ìˆ˜ë½</button>
              <button onclick="declineInvite(${invite.diaryId})">ê±°ì ˆ</button>
              <hr/>
            `;
                listDiv.appendChild(entry);
              });
            }

            document.getElementById("invite-modal").style.display = "block";
          })
          .catch((err) => alert(err.message));
      }

      function closeInvitePopup() {
        document.getElementById("invite-modal").style.display = "none";
      }

      function acceptInvite(diaryId) {
        fetch(`/api/diary/${diaryId}/accept`, { method: "POST" })
          .then((res) => {
            if (!res.ok) throw new Error("ìˆ˜ë½ ì‹¤íŒ¨");
            alert("ì´ˆëŒ€ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.");
            closeInvitePopup();
            location.reload();
          })
          .catch((err) => alert(err.message));
      }

      function declineInvite(diaryId) {
        fetch(`/api/diary/${diaryId}/decline`, { method: "DELETE" })
          .then((res) => {
            if (!res.ok) throw new Error("ê±°ì ˆ ì‹¤íŒ¨");
            alert("ì´ˆëŒ€ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
            closeInvitePopup();
            location.reload();
          })
          .catch((err) => alert(err.message));
      }

      // ì¼ê¸°ì¥ ì‚­ì œ
      function deleteDiary(diaryId) {
        if (!confirm("ì •ë§ ì¼ê¸°ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/diary/${diaryId}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
            return res.status === 204 ? null : res.json(); // âœ… 204ë©´ JSON íŒŒì‹± ì•ˆí•¨
          })
          .then(() => {
            alert("ì‚­ì œ ì™„ë£Œ");
            location.reload();
          })
          .catch((err) => alert(err.message));
      }
    </script>
  </body>
</html>
